# üõ°Ô∏è Sistema de Protecci√≥n de Pasos en Procesos

## üìã Descripci√≥n General

Sistema integral de protecci√≥n contra p√©rdida de trabajo en el m√≥dulo de procesos de negociaci√≥n. Implementa un flujo de trabajo expl√≠cito donde el usuario debe iniciar un paso antes de trabajar en √©l, con advertencias antes de perder cambios no guardados.

---

## üéØ Caracter√≠sticas Implementadas

### 1. **Flujo de Trabajo Expl√≠cito**

El usuario debe seguir este flujo:

```
PENDIENTE ‚Üí [Iniciar Paso] ‚Üí EN PROCESO ‚Üí [Completar/Descartar] ‚Üí COMPLETADO/PENDIENTE
```

#### Estados del Paso:

1. **Pendiente** (inicial)
   - ‚ùå No se puede adjuntar documentos
   - ‚ùå Secci√≥n de adjuntos oculta
   - ‚úÖ Bot√≥n "Iniciar Paso" visible
   - Sin advertencia de cambios

2. **En Proceso** (trabajando)
   - ‚úÖ Adjuntos desplegados y editables
   - ‚úÖ Bot√≥n "Completar Paso" visible
   - ‚úÖ Bot√≥n "Descartar Cambios" visible
   - ‚ö†Ô∏è **Advertencia activa** si intenta salir

3. **Completado** (finalizado)
   - ‚úÖ Todo visible pero deshabilitado
   - üìÖ Fechas registradas (inicio + completado)
   - Sin opciones de edici√≥n

---

### 2. **Sistema de Advertencia beforeunload**

```typescript
useEffect(() => {
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    if (pasoEnEdicion) {
      e.preventDefault()
      e.returnValue = '' // Chrome requiere esto
      return '' // Otros navegadores
    }
  }

  window.addEventListener('beforeunload', handleBeforeUnload)

  return () => {
    window.removeEventListener('beforeunload', handleBeforeUnload)
  }
}, [pasoEnEdicion])
```

**Se activa cuando:**
- Usuario tiene paso en estado "En Proceso"
- Intenta cerrar pesta√±a/ventana
- Intenta navegar a otra p√°gina
- Refresca la p√°gina (F5)

**Mensaje del navegador:**
> "¬øEst√°s seguro de que quieres salir de esta p√°gina? Es posible que los cambios que has realizado no se guarden."

---

### 3. **Modal de Fecha de Completado**

Al presionar "Completar Paso", aparece un modal para especificar la fecha real de completado.

#### Caracter√≠sticas:
- **Fecha por defecto**: Hoy (autom√°tica)
- **Fecha m√≠nima**: Fecha de inicio del paso (o hace 30 d√≠as si no hay inicio)
- **Fecha m√°xima**: Hoy (no permite fechas futuras)
- **Validaciones**:
  - ‚ùå No permite fechas futuras
  - ‚ùå No permite fechas anteriores al inicio del paso
  - ‚úÖ Muestra fecha de inicio como referencia
  - ‚úÖ Formato amigable (DD de Mes de AAAA)

#### C√≥digo:
```typescript
const handleConfirmarCompletado = async (fecha: Date) => {
  if (!pasoACompletar) return

  const exito = await completarPaso(pasoACompletar.id, fecha)

  if (exito) {
    setModalFechaAbierto(false)
    setPasoACompletar(null)
    setPasoExpandido(null)
  }
}
```

---

### 4. **Funci√≥n Descartar Cambios**

Permite revertir un paso "En Proceso" a "Pendiente", eliminando todo el progreso.

#### Confirmaci√≥n previa:
```
‚ö†Ô∏è ¬øDescartar todos los cambios?

‚Ä¢ Se eliminar√°n los documentos adjuntos
‚Ä¢ Se borrar√° la fecha de inicio
‚Ä¢ El paso volver√° a estado Pendiente

Esta acci√≥n no se puede deshacer.
```

#### L√≥gica:
```typescript
const descartarCambios = async (pasoId: string): Promise<boolean> => {
  const actualizado = await actualizarProceso(pasoId, {
    estado: EstadoPaso.PENDIENTE,
    fechaInicio: null,
    documentosUrls: null, // Eliminar documentos
    notas: null
  })

  setPasoEnEdicion(null) // Desactivar advertencia
  return true
}
```

---

## üîß Implementaci√≥n T√©cnica

### Hook `useProcesoNegociacion.ts`

#### Nuevas funciones:

1. **`iniciarPaso(pasoId)`**
   - Cambia estado a "En Proceso"
   - Registra `fecha_inicio = NOW()`
   - Marca `pasoEnEdicion = pasoId`

2. **`completarPaso(pasoId, fechaCompletado)`**
   - Acepta fecha personalizada (no solo NOW())
   - Registra `fecha_completado = fechaCompletado`
   - Limpia `pasoEnEdicion = null`

3. **`descartarCambios(pasoId)`**
   - Vuelve a estado "Pendiente"
   - Limpia `fecha_inicio`, `documentos_urls`, `notas`
   - Limpia `pasoEnEdicion = null`

4. **`eliminarDocumento(pasoId, documentoId)`**
   - Elimina documento del paso (solo en "En Proceso")

5. **`puedeIniciar(paso)`**
   - Verifica si paso est√° en "Pendiente" y no bloqueado

#### Nuevos estados:

```typescript
const [pasoEnEdicion, setPasoEnEdicion] = useState<string | null>(null)
```

---

### Componente `timeline-proceso.tsx`

#### Nuevos handlers:

```typescript
const handleIniciarPaso = async (pasoId: string) => {
  if (!confirm('¬øIniciar trabajo en este paso?')) return
  const exito = await iniciarPaso(pasoId)
  if (exito) setPasoExpandido(pasoId) // Auto-expandir
}

const handleAbrirModalCompletar = (paso: ProcesoNegociacion) => {
  setPasoACompletar(paso)
  setModalFechaAbierto(true)
}

const handleDescartarCambios = async (pasoId: string) => {
  if (!confirm('‚ö†Ô∏è ¬øDescartar todos los cambios?')) return
  await descartarCambios(pasoId)
}
```

#### Cambios en UI:

**Paso Pendiente:**
```tsx
{isPendiente && puedeIniciar && (
  <button onClick={onIniciar}>
    <Play /> Iniciar Paso
  </button>
)}

{isPendiente && (
  <div className="alert-info">
    Presiona "Iniciar Paso" para empezar a trabajar
  </div>
)}
```

**Paso En Proceso:**
```tsx
{isEnProceso && (
  <>
    <button onClick={onCompletar} disabled={!puedeCompletar}>
      <CheckCircle2 /> Completar Paso
    </button>

    <button onClick={onDescartar}>
      <Trash2 /> Descartar Cambios
    </button>
  </>
)}
```

**Documentos (solo visible si En Proceso o Completado):**
```tsx
{(isEnProceso || isCompletado) && (
  <DocumentosRequeridos
    paso={paso}
    soloLectura={isCompletado}
  />
)}
```

---

### Componente `modal-fecha-completado.tsx`

```tsx
<ModalFechaCompletado
  isOpen={modalFechaAbierto}
  pasoNombre={pasoACompletar?.nombre || ''}
  fechaInicio={pasoACompletar?.fechaInicio}
  onConfirm={handleConfirmarCompletado}
  onCancel={() => setModalFechaAbierto(false)}
/>
```

#### Validaciones del modal:

```typescript
if (fechaSeleccionada > ahora) {
  setError('La fecha no puede ser futura')
  return
}

if (fechaInicio && fechaSeleccionada < new Date(fechaInicio)) {
  setError('La fecha no puede ser anterior al inicio del paso')
  return
}
```

---

## üìä Actualizaci√≥n del Header

Ahora muestra **4 estad√≠sticas** en lugar de 3:

```tsx
<div className="grid grid-cols-4 gap-4">
  <div>
    <div>{progreso.pasosCompletados}</div>
    <div>Completados</div>
  </div>
  <div>
    <div>{progreso.pasosEnProceso}</div>
    <div>En Proceso</div>
  </div>
  <div>
    <div>{progreso.pasosPendientes}</div>
    <div>Pendientes</div>
  </div>
  <div>
    <div>{progreso.totalPasos}</div>
    <div>Total</div>
  </div>
</div>
```

**Servicio actualizado:**
```typescript
export async function obtenerProgresoNegociacion(negociacionId: string) {
  const procesos = await obtenerProcesosNegociacion(negociacionId)

  const completados = procesos.filter(p => p.estado === EstadoPaso.COMPLETADO).length
  const enProceso = procesos.filter(p => p.estado === EstadoPaso.EN_PROCESO).length
  const pendientes = procesos.filter(p => p.estado === EstadoPaso.PENDIENTE).length
  const omitidos = procesos.filter(p => p.estado === EstadoPaso.OMITIDO).length

  return {
    pasosCompletados: completados,
    pasosEnProceso: enProceso,
    pasosPendientes: pendientes,
    pasosOmitidos: omitidos,
    porcentajeCompletado: Math.round((completados / procesos.length) * 100)
  }
}
```

---

## üé® Badges de Estado

```tsx
const getBadge = () => {
  if (isCompletado) return (
    <span className="bg-green-100 text-green-700">
      ‚úì Completado
    </span>
  )

  if (isEnProceso) return (
    <span className="bg-blue-100 text-blue-700">
      <div className="animate-pulse" /> En Proceso
    </span>
  )

  if (isBloqueado) return (
    <span className="bg-gray-200 text-gray-600">
      <Lock /> Bloqueado
    </span>
  )

  return (
    <span className="bg-amber-100 text-amber-700">
      Pendiente
    </span>
  )
}
```

---

## üîí Flujo de Protecci√≥n Completo

### Escenario 1: Usuario inicia paso y completa normalmente

```
1. Usuario hace clic en "Iniciar Paso"
   ‚Üí Confirmaci√≥n: "¬øIniciar trabajo en este paso?"
   ‚Üí Estado cambia a "En Proceso"
   ‚Üí fecha_inicio = NOW()
   ‚Üí Adjuntos se despliegan

2. Usuario adjunta documentos
   ‚Üí Documentos se guardan en DB
   ‚Üí No se puede cerrar p√°gina sin advertencia

3. Usuario hace clic en "Completar Paso"
   ‚Üí Modal de fecha aparece
   ‚Üí Usuario selecciona fecha (por defecto: hoy)
   ‚Üí Estado cambia a "Completado"
   ‚Üí fecha_completado = fecha seleccionada
   ‚Üí Advertencia se desactiva
```

### Escenario 2: Usuario inicia paso pero quiere descartar

```
1. Usuario hace clic en "Iniciar Paso"
   ‚Üí Estado = "En Proceso"
   ‚Üí Adjuntos desplegados

2. Usuario adjunta 1 documento
   ‚Üí Documento guardado

3. Usuario se arrepiente y hace clic en "Descartar Cambios"
   ‚Üí Confirmaci√≥n: "‚ö†Ô∏è ¬øDescartar todos los cambios?"
   ‚Üí Estado vuelve a "Pendiente"
   ‚Üí Documentos eliminados
   ‚Üí fecha_inicio = NULL
   ‚Üí Advertencia se desactiva
```

### Escenario 3: Usuario intenta salir sin completar

```
1. Usuario tiene paso en "En Proceso"
   ‚Üí pasoEnEdicion = pasoId

2. Usuario intenta:
   - Cerrar pesta√±a (Ctrl+W)
   - Cerrar ventana (Alt+F4)
   - Navegar a otra URL
   - Refrescar p√°gina (F5)

3. Navegador muestra advertencia nativa:
   ‚Üí "¬øEst√°s seguro de que quieres salir?"
   ‚Üí Usuario debe confirmar expl√≠citamente

4. Opciones del usuario:
   A. Cancelar ‚Üí Permanece en la p√°gina
   B. Salir de todos modos ‚Üí Pierde cambios (DB mantiene estado "En Proceso")
```

---

## üìù Casos de Uso

### ‚úÖ Caso 1: Completar paso el mismo d√≠a

```
Fecha inicio: 27 Oct 2025 10:00 AM
Usuario completa: 27 Oct 2025 3:00 PM
Modal muestra: 27 Oct 2025 (por defecto)
Usuario confirma ‚Üí ‚úÖ Fechas correctas
```

### ‚úÖ Caso 2: Completar paso d√≠as despu√©s

```
Fecha inicio: 24 Oct 2025
Usuario completa: 27 Oct 2025
Modal muestra: 27 Oct 2025 (por defecto)
Usuario cambia a: 25 Oct 2025 (fecha real de completado)
Usuario confirma ‚Üí ‚úÖ Fechas correctas
```

### ‚ùå Caso 3: Fecha futura (bloqueado)

```
Hoy: 27 Oct 2025
Usuario selecciona: 28 Oct 2025
Modal muestra error: "La fecha no puede ser futura"
```

### ‚ùå Caso 4: Fecha anterior al inicio (bloqueado)

```
Fecha inicio: 25 Oct 2025
Usuario selecciona: 24 Oct 2025
Modal muestra error: "La fecha no puede ser anterior al inicio del paso"
```

---

## üöÄ Pr√≥ximas Mejoras (Opcionales)

1. **Guardado autom√°tico** de documentos en segundo plano
2. **Historial de cambios** descartados (auditoria)
3. **Recordatorio** si paso lleva > 7 d√≠as "En Proceso"
4. **Autocompletado** de fecha basado en √∫ltimo documento subido
5. **Deshacer** descarte (hasta X minutos despu√©s)

---

## üìö Archivos Modificados

```
src/modules/admin/procesos/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useProcesoNegociacion.ts        # ‚úÖ Nuevas funciones
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ timeline-proceso.tsx            # ‚úÖ UI actualizada
‚îÇ   ‚îú‚îÄ‚îÄ modal-fecha-completado.tsx      # üÜï Modal nuevo
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                        # ‚úÖ Export a√±adido
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ procesos.service.ts             # ‚úÖ Progreso actualizado
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ index.ts                        # (Sin cambios)
```

---

## ‚ú® Resumen de Beneficios

| Antes | Despu√©s |
|-------|---------|
| Usuario pod√≠a adjuntar sin iniciar | Debe presionar "Iniciar Paso" |
| Fechas siempre NOW() | Usuario especifica fecha real |
| Sin advertencia al salir | Advertencia beforeunload activa |
| Cambios se guardaban autom√°ticamente | Usuario debe completar o descartar |
| Sin forma de revertir | Bot√≥n "Descartar Cambios" |
| 3 estados confusos | Flujo claro: Pendiente ‚Üí En Proceso ‚Üí Completado |

---

**Fecha de implementaci√≥n**: 27 de octubre de 2025
**Versi√≥n**: 2.0.0
**Estado**: ‚úÖ Completado y probado
