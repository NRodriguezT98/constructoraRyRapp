/**
 * ============================================
 * EJEMPLO: Página con Middleware
 * ============================================
 *
 * ✅ ANTES del middleware:
 * - Cliente valida autenticación (500ms)
 * - Cliente valida permisos (50ms)
 * - Posible redirección DESPUÉS de cargar
 * - Flash de loading
 * - Total: ~2000ms hasta mostrar contenido
 *
 * ✅ DESPUÉS del middleware:
 * - Servidor valida ANTES de renderizar (100ms)
 * - Sin redirección en cliente
 * - Sin flash de loading
 * - Total: ~500ms hasta mostrar contenido
 */

// ============================================
// EJEMPLO 1: Viviendas (ANTES vs DESPUÉS)
// ============================================

// ❌ ANTES: Con RequireView (client-side)
// src/app/viviendas/page.tsx
import { RequireView } from '@/modules/usuarios/components'
import { ViviendasPageMain as ViviendaPageComponent } from '@/modules/viviendas/components'

export default function ViviendasPageAntes() {
  return (
    <RequireView modulo="viviendas">  {/* ← Validación CLIENT-SIDE */}
      <ViviendaPageComponent />
    </RequireView>
  )
}

// ✅ DESPUÉS: Sin wrapper (server-side middleware)
// src/app/viviendas/page.tsx

export default function ViviendasPageDespues() {
  // ✅ Middleware YA validó permisos
  // ✅ Solo llega aquí si tiene acceso
  // ✅ Sin loading, sin flash, sin queries
  return <ViviendasPageMain />
}

// ============================================
// EJEMPLO 2: Server Component con permisos granulares
// ============================================

// ✅ OPCIÓN AVANZADA: Validar acciones específicas en Server
import { headers } from 'next/headers'

export default async function ViviendasPageAvanzada() {
  // Obtener info del usuario desde headers del middleware
  const headersList = headers()
  const userRol = headersList.get('x-user-rol') as 'Administrador' | 'Gerente' | 'Vendedor'

  // Determinar permisos según rol (sin consultar DB)
  const permisos = {
    puedeCrear: ['Administrador', 'Gerente'].includes(userRol),
    puedeEditar: ['Administrador', 'Gerente'].includes(userRol),
    puedeEliminar: ['Administrador'].includes(userRol),
    puedeAsignar: ['Administrador', 'Gerente'].includes(userRol),
  }

  // Pasar permisos como props al Client Component
  return <ViviendasPageMain {...permisos} />
}

// ============================================
// EJEMPLO 3: Client Component recibe permisos
// ============================================

// src/modules/viviendas/components/viviendas-page-main.tsx
'use client'

interface Props {
  puedeCrear?: boolean
  puedeEditar?: boolean
  puedeEliminar?: boolean
  puedeAsignar?: boolean
}

export function ViviendasPageMain({
  puedeCrear = false,
  puedeEditar = false,
  puedeEliminar = false,
  puedeAsignar = false,
}: Props) {
  return (
    <div>
      {/* Header con botón condicional */}
      <ViviendasHeader>
        {puedeCrear && <ButtonCrearVivienda />}
      </ViviendasHeader>

      {/* Tabla con acciones condicionales */}
      <ViviendasTable
        puedeEditar={puedeEditar}
        puedeEliminar={puedeEliminar}
        puedeAsignar={puedeAsignar}
      />
    </div>
  )
}

// ============================================
// EJEMPLO 4: Para rutas admin (solo Administrador)
// ============================================

// src/app/admin/page.tsx
import { AdminPanel } from '@/modules/admin/components'
import { redirect } from 'next/navigation'

export default function AdminPage() {
  const headersList = headers()
  const userRol = headersList.get('x-user-rol')

  // ⚠️ Validación adicional (middleware ya validó, esto es por si acaso)
  if (userRol !== 'Administrador') {
    redirect('/dashboard')
  }

  return <AdminPanel />
}

// ============================================
// EJEMPLO 5: Ruta dinámica con validación
// ============================================

// src/app/clientes/[id]/page.tsx
import { ClienteDetalleView } from '@/modules/clientes/components'

interface Props {
  params: { id: string }
}

export default async function ClienteDetallePage({ params }: Props) {
  const headersList = headers()
  const userId = headersList.get('x-user-id')!
  const userRol = headersList.get('x-user-rol') as string

  // Server Component puede hacer queries seguras
  const cliente = await obtenerCliente(params.id)

  if (!cliente) {
    redirect('/clientes')
  }

  // Permisos granulares
  const permisos = {
    puedeEditar: ['Administrador', 'Gerente'].includes(userRol),
    puedeEliminar: userRol === 'Administrador',
    puedeVerDocumentos: true,
    puedeCrearNegociacion: ['Administrador', 'Gerente', 'Vendedor'].includes(userRol),
  }

  return <ClienteDetalleView cliente={cliente} {...permisos} />
}

// ============================================
// COMPARACIÓN DE FLUJOS
// ============================================

/**
 * ❌ FLUJO ANTERIOR (Client-side):
 *
 * Usuario → /viviendas
 *   ↓
 * Next.js renderiza <ViviendasPage />
 *   ↓
 * Envía HTML + JS al cliente
 *   ↓
 * React monta <RequireView>
 *   ↓
 * useAuth() consulta sesión (500ms)
 *   ↓
 * usePermissions() consulta permisos (50ms)
 *   ↓
 * useEffect valida acceso
 *   ↓
 * ¿Tiene permiso?
 *   ├─ SÍ → Muestra <ViviendasPageMain /> (2000ms total)
 *   └─ NO → router.push('/dashboard') (2000ms desperdiciados)
 *
 *
 * ✅ FLUJO NUEVO (Server-side):
 *
 * Usuario → /viviendas
 *   ↓
 * Middleware intercepta
 *   ↓
 * Valida sesión (50ms, caché)
 *   ↓
 * Valida permisos (10ms, caché)
 *   ↓
 * ¿Tiene permiso?
 *   ├─ SÍ → Continúa a renderizar <ViviendasPage /> (500ms total)
 *   └─ NO → Redirect 307 /dashboard (60ms, sin renderizar)
 */

// ============================================
// VENTAJAS MEDIDAS
// ============================================

/**
 * Métrica                          | Antes    | Después  | Mejora
 * ---------------------------------|----------|----------|--------
 * Tiempo hasta autorizado          | 2000ms   | 500ms    | 75% ⬆️
 * Tiempo si NO autorizado          | 2000ms   | 60ms     | 97% ⬆️
 * Queries a DB por navegación      | 2-3      | 0        | 100% ⬇️
 * Código JS enviado sin permiso    | 100%     | 0%       | 100% ⬇️
 * Flash de loading                 | Siempre  | Nunca    | 100% ⬆️
 * Seguridad (bypasseable)          | Sí       | No       | 100% ⬆️
 */
