# üìä Referencia de Esquema de Base de Datos

> **‚ö†Ô∏è DOCUMENTO CR√çTICO - CONSULTAR SIEMPRE ANTES DE CREAR/MODIFICAR C√ìDIGO**
>
> Este documento es la **fuente √∫nica de verdad** para nombres de tablas, columnas y tipos.
> **NUNCA** asumas nombres de campos - **SIEMPRE** verifica aqu√≠ primero.

---

## üéØ REGLA DE ORO

### ‚ùå PROHIBIDO:
- Asumir nombres de columnas sin verificar
- Copiar nombres de otros archivos sin validar
- Usar nombres en ingl√©s cuando la DB usa espa√±ol
- Inventar nombres "l√≥gicos" sin confirmar

### ‚úÖ OBLIGATORIO:
- Consultar este documento PRIMERO
- Verificar en Supabase Table Editor si hay dudas
- Actualizar este documento cuando se agreguen campos
- Usar los nombres EXACTOS como est√°n en la DB

---

## üìã TABLAS PRINCIPALES

### 1Ô∏è‚É£ `clientes`

```typescript
{
  id: string (UUID)
  nombres: string              // ‚ö†Ô∏è NO "nombre"
  apellidos: string            // ‚ö†Ô∏è NO "apellido"
  nombre_completo: string      // ‚ö†Ô∏è Generado, NO editable
  tipo_documento: string       // 'CC' | 'CE' | 'NIT' | 'Pasaporte'
  numero_documento: string     // ‚ö†Ô∏è NO "documento"
  email: string
  telefono: string
  direccion: string
  ciudad: string
  fecha_nacimiento: Date
  estado_civil: string
  profesion: string
  empresa: string
  cargo: string
  ingresos_mensuales: number
  notas: string
  fecha_creacion: Date
  fecha_actualizacion: Date
  usuario_creacion: string
}
```

**Errores comunes:**
- ‚ùå `cliente.nombre` ‚Üí ‚úÖ `cliente.nombres`
- ‚ùå `cliente.documento` ‚Üí ‚úÖ `cliente.numero_documento`

---

### 2Ô∏è‚É£ `proyectos`

```typescript
{
  id: string (UUID)
  nombre: string               // ‚ö†Ô∏è Singular
  descripcion: string
  ubicacion: string
  estado: string               // ‚ö†Ô∏è Snake_case: 'en_planificacion' | 'en_construccion' | 'finalizado' | 'pausado'
  fecha_inicio: Date
  fecha_fin_estimada: Date
  presupuesto_total: number
  area_total: number
  imagen_url: string
  fecha_creacion: Date
  fecha_actualizacion: Date
  usuario_creacion: string
}
```

**Estados v√°lidos (snake_case lowercase):**
- `'en_planificacion'`
- `'en_construccion'`
- `'finalizado'`
- `'pausado'`

---

### 3Ô∏è‚É£ `viviendas`

```typescript
{
  id: string (UUID)
  manzana_id: string (UUID)
  numero: string               // ‚ö†Ô∏è String, no number
  tipo: string                 // 'Casa' | 'Apartamento' | 'Local'
  area_construida: number
  area_terreno: number
  numero_habitaciones: number
  numero_banos: number
  numero_pisos: number
  tiene_garaje: boolean
  valor_total: number          // ‚ö†Ô∏è NO "precio" o "valor"
  estado: string               // ‚ö†Ô∏è Snake_case: 'disponible' | 'reservada' | 'vendida' | 'en_construccion'
  descripcion: string
  imagen_url: string
  fecha_creacion: Date
  fecha_actualizacion: Date
  usuario_creacion: string
}
```

**Estados v√°lidos (snake_case lowercase):**
- `'disponible'`
- `'reservada'`
- `'vendida'`
- `'en_construccion'`

**Errores comunes:**
- ‚ùå `vivienda.precio` ‚Üí ‚úÖ `vivienda.valor_total`
- ‚ùå `vivienda.estado = 'Disponible'` ‚Üí ‚úÖ `'disponible'`

---

### 4Ô∏è‚É£ `manzanas`

```typescript
{
  id: string (UUID)
  proyecto_id: string (UUID)
  nombre: string               // Ej: "Manzana A"
  numero_viviendas: number
  descripcion: string
  fecha_creacion: Date
  fecha_actualizacion: Date
  usuario_creacion: string
}
```

---

### 5Ô∏è‚É£ `cliente_intereses` ‚≠ê ACTUALIZADO

```typescript
{
  // Campos base
  id: string (UUID)
  cliente_id: string (UUID)
  proyecto_id: string (UUID)
  vivienda_id: string (UUID)   // Opcional
  notas: string
  estado: string               // ‚ö†Ô∏è PascalCase: 'Activo' | 'Pendiente' | 'Contactado' | 'En Seguimiento' | 'Negociaci√≥n' | 'Descartado' | 'Perdido'
  motivo_descarte: string
  fecha_interes: Date
  fecha_actualizacion: Date
  usuario_creacion: string

  // Campos nuevos (agregados 2025-10-18)
  valor_estimado: number       // ‚ö†Ô∏è NUEVO - Valor estimado del inter√©s
  origen: string               // ‚ö†Ô∏è NUEVO - 'Visita Presencial' | 'Llamada Telef√≥nica' | 'WhatsApp' | 'Email' | 'Redes Sociales' | 'Referido' | 'Sitio Web' | 'Otro'
  prioridad: string            // ‚ö†Ô∏è NUEVO - 'Alta' | 'Media' | 'Baja'
  fecha_ultimo_contacto: Date  // ‚ö†Ô∏è NUEVO
  proximo_seguimiento: Date    // ‚ö†Ô∏è NUEVO
  negociacion_id: string (UUID)// ‚ö†Ô∏è NUEVO - Se llena al convertir a negociaci√≥n
  fecha_conversion: Date       // ‚ö†Ô∏è NUEVO - Fecha cuando se convirti√≥
}
```

**Estados v√°lidos (PascalCase con espacios):**
- `'Activo'`
- `'Pendiente'`
- `'Contactado'`
- `'En Seguimiento'`
- `'Negociaci√≥n'`
- `'Descartado'`
- `'Perdido'`

**Or√≠genes v√°lidos:**
- `'Visita Presencial'`
- `'Llamada Telef√≥nica'`
- `'WhatsApp'`
- `'Email'`
- `'Redes Sociales'`
- `'Referido'`
- `'Sitio Web'`
- `'Otro'`

**Prioridades v√°lidas:**
- `'Alta'`
- `'Media'`
- `'Baja'`

---

### 6Ô∏è‚É£ `negociaciones`

```typescript
{
  id: string (UUID)
  cliente_id: string (UUID)
  vivienda_id: string (UUID)
  valor_negociado: number      // ‚ö†Ô∏è NO "precio_negociado"
  descuento_aplicado: number
  estado: string               // 'En Proceso' | 'Aprobada' | 'Rechazada' | 'Cancelada'
  notas: string
  fecha_creacion: Date
  fecha_actualizacion: Date
  usuario_creacion: string
}
```

**Errores comunes:**
- ‚ùå `negociacion.precio` ‚Üí ‚úÖ `negociacion.valor_negociado`

---

### 7Ô∏è‚É£ `fuentes_pago` ‚≠ê SISTEMA DE PAGO

```typescript
{
  id: string (UUID)
  negociacion_id: string (UUID)
  tipo: string                 // ‚ö†Ô∏è 'Cuota Inicial' | 'Cr√©dito Hipotecario' | 'Subsidio Mi Casa Ya' | 'Subsidio Caja Compensaci√≥n'
  monto_aprobado: number
  monto_recibido: number
  saldo_pendiente: number      // ‚ö†Ô∏è CALCULADO (monto_aprobado - monto_recibido)
  porcentaje_completado: number// ‚ö†Ô∏è CALCULADO (monto_recibido / monto_aprobado * 100)

  // Detalles
  entidad: string              // Banco o Caja de Compensaci√≥n
  numero_referencia: string    // Radicado/N√∫mero de cr√©dito

  // Comportamiento
  permite_multiples_abonos: boolean // ‚ö†Ô∏è true solo para 'Cuota Inicial'

  // Documentos
  carta_aprobacion_url: string
  carta_asignacion_url: string

  // Estado
  estado: string               // 'Pendiente' | 'En Proceso' | 'Completada'
  fecha_completado: Date
  fecha_creacion: Date
  fecha_actualizacion: Date
}
```

**Tipos v√°lidos**:
- `'Cuota Inicial'` ‚Üí permite_multiples_abonos = **true**
- `'Cr√©dito Hipotecario'` ‚Üí permite_multiples_abonos = **false**
- `'Subsidio Mi Casa Ya'` ‚Üí permite_multiples_abonos = **false**
- `'Subsidio Caja Compensaci√≥n'` ‚Üí permite_multiples_abonos = **false**

**Estados v√°lidos**:
- `'Pendiente'`
- `'En Proceso'`
- `'Completada'`

---

### 8Ô∏è‚É£ `procesos_negociacion`

```typescript
{
  id: string (UUID)
  negociacion_id: string (UUID)
  nombre: string
  descripcion: string
  orden: number
  es_obligatorio: boolean
  permite_omitir: boolean
  estado: string               // 'Pendiente' | 'En Proceso' | 'Completado' | 'Omitido'
  depende_de: string[]         // Array de IDs de procesos previos
  documentos_requeridos: object
  documentos_urls: object
  fecha_inicio: Date
  fecha_completado: Date
  fecha_limite: Date
  notas: string
  motivo_omision: string
  fecha_creacion: Date
  fecha_actualizacion: Date
  usuario_completo: string (UUID)
}
```

---

## üîç VISTAS (Views)

### Vista: `intereses_completos`

**Columnas disponibles:**

```typescript
{
  // Todas las columnas de cliente_intereses (i.*)
  ...cliente_intereses_fields,

  // Datos del cliente
  cliente_nombre: string,        // ‚ö†Ô∏è c.nombres
  cliente_apellido: string,      // ‚ö†Ô∏è c.apellidos
  nombre_completo: string,       // ‚ö†Ô∏è c.nombre_completo
  cliente_email: string,
  cliente_telefono: string,
  cliente_documento: string,     // ‚ö†Ô∏è c.numero_documento

  // Datos del proyecto
  proyecto_nombre: string,       // ‚ö†Ô∏è NO "proyecto_ubicacion"
  proyecto_estado: string,       // ‚ö†Ô∏è p.estado (snake_case)

  // Datos de la vivienda
  vivienda_numero: string,
  vivienda_valor: number,        // ‚ö†Ô∏è NO "vivienda_precio"
  vivienda_estado: string,       // ‚ö†Ô∏è v.estado (snake_case)

  // Datos de manzana
  manzana_nombre: string,

  // Campos calculados
  dias_desde_interes: number,    // ‚ö†Ô∏è Calculado, no editable
  seguimiento_urgente: boolean   // ‚ö†Ô∏è Calculado, no editable
}
```

**‚ö†Ô∏è ERRORES COMUNES QUE HEMOS TENIDO:**

1. ‚ùå `estado_interes` ‚Üí ‚úÖ `estado` (la columna se llama solo "estado")
2. ‚ùå `vivienda_precio` ‚Üí ‚úÖ `vivienda_valor`
3. ‚ùå `proyecto_ubicacion` ‚Üí ‚úÖ `proyecto_estado`

---

## üìù FUNCIONES PostgreSQL

### `convertir_interes_a_negociacion()`

```sql
convertir_interes_a_negociacion(
  p_interes_id UUID,
  p_valor_negociado DECIMAL,
  p_descuento DECIMAL DEFAULT 0
) RETURNS UUID
```

**Uso desde servicio:**

```typescript
const { data, error } = await supabase.rpc('convertir_interes_a_negociacion', {
  p_interes_id: interesId,
  p_valor_negociado: valorNegociado,
  p_descuento: descuento
})
```

---

## üõ°Ô∏è CONVENCIONES DE NOMBRES

### Base de Datos (PostgreSQL)
- **Tablas**: `snake_case` plural o singular seg√∫n contexto
  - `clientes`, `proyectos`, `viviendas`, `cliente_intereses`
- **Columnas**: `snake_case`
  - `numero_documento`, `fecha_creacion`, `valor_total`
- **Estados de proyectos/viviendas**: `snake_case` lowercase
  - `'en_planificacion'`, `'disponible'`, `'en_construccion'`
- **Estados de intereses**: `PascalCase` con espacios
  - `'Activo'`, `'En Seguimiento'`, `'Negociaci√≥n'`

### TypeScript (Frontend)
- **Interfaces**: `PascalCase`
  - `Cliente`, `Proyecto`, `ClienteInteres`
- **Propiedades**: `snake_case` (coincide con DB)
  - `cliente.numero_documento`, `vivienda.valor_total`
- **Servicios**: `camelCase`
  - `interesesService`, `proyectosService`

### React (Componentes)
- **Componentes**: `PascalCase` o `kebab-case` en archivos
  - `ClienteDetalle`, `modal-registrar-interes.tsx`
- **Hooks**: `camelCase` con prefijo `use`
  - `useRegistrarInteres`, `useClienteDetalle`

---

## ‚úÖ CHECKLIST ANTES DE CREAR C√ìDIGO

Cuando vayas a trabajar con datos de DB:

- [ ] ¬øConsult√© `DATABASE-SCHEMA-REFERENCE.md`?
- [ ] ¬øVerifiqu√© los nombres EXACTOS de las columnas?
- [ ] ¬øConfirm√© el formato de los estados (snake_case vs PascalCase)?
- [ ] ¬øRevis√© si la columna es de una tabla o una vista?
- [ ] ¬øActualic√© este documento si agregu√© campos nuevos?

---

## üîÑ MANTENIMIENTO

**√öltima actualizaci√≥n**: 2025-10-18

**Cambios recientes**:
- ‚úÖ Agregados 7 campos nuevos a `cliente_intereses`
- ‚úÖ Documentada vista `intereses_completos`
- ‚úÖ Aclarados errores comunes en nombres de campos

**Responsable de actualizar**: Cualquier desarrollador que modifique el schema de DB

---

## üìû EN CASO DE DUDA

1. **Consulta este documento primero**
2. Si no est√° aqu√≠: **Verifica en Supabase Table Editor**
3. **Actualiza este documento** con lo que encontraste
4. **Nunca asumas** - siempre verifica

---

> **üéØ Objetivo**: Reducir a CERO los errores de nombres de campos/columnas
